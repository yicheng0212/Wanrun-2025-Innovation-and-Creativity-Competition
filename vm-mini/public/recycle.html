<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>回收端操作｜循環販賣機</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link rel="stylesheet" href="/assets/styles.css">
</head>
<body class="min-vh-100 d-flex flex-column page-recycle">
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
    <div class="container">
      <a class="navbar-brand fw-semibold" href="/index.html"><i class="bi bi-recycle me-2"></i>循環販賣機 DEMO</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav" aria-controls="mainNav" aria-expanded="false" aria-label="切換導覽">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="mainNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="/scan.html">會員掃描</a></li>
          <li class="nav-item"><a class="nav-link" href="/shop.html">訪客購物</a></li>
          <li class="nav-item"><a class="nav-link" href="/checkout.html">三段式結帳</a></li>
          <li class="nav-item"><a class="nav-link active" aria-current="page" href="/recycle.html">回收端</a></li>
          <li class="nav-item"><a class="nav-link" href="/dashboard.html">ESG 儀表板</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <main class="flex-grow-1 py-5">
    <div class="container">
      <div class="glass-card p-5 shadow-lg">
        <div class="d-flex flex-column flex-lg-row justify-content-between gap-4 mb-4">
          <div>
            <span class="badge bg-success-subtle text-success-emphasis mb-3">Step 6</span>
            <h1 class="fw-bold text-primary mb-2"><i class="bi bi-recycle me-2"></i>回收端三階段作業</h1>
            <p class="text-secondary mb-0">先鎖定會員，再掃描商品條碼／收據碼，最後確認退押金與 ESG 成效。</p>
          </div>
          <div class="text-lg-end">
            <div class="step-bubbles mb-3 justify-content-lg-end">
              <div class="step-bubble active" data-step="member" data-label="會員">1</div>
              <div class="step-bubble" data-step="code" data-label="條碼">2</div>
              <div class="step-bubble" data-step="result" data-label="確認">3</div>
            </div>
            <div class="step-status-text" id="stepHint">請掃描會員卡後自動前往條碼掃描</div>
          </div>
        </div>


        <section class="checkout-step active" data-step="member">
          <div class="glass-card recycle-card p-5">
            <div class="row g-4 align-items-center">
              <div class="col-lg-4 d-flex justify-content-center">
                <div class="recycle-hero-icon">
                  <i class="bi bi-person-badge"></i>
                </div>
              </div>
              <div class="col-lg-8">
                <div class="scan-display recycle-scan">
                  <input id="memInput" placeholder="JCP-XXXXXX" autocomplete="off" inputmode="text">
                  <small>掃描會員卡條碼或手動輸入卡號，系統會即時驗證並顯示押金餘額。</small>
                  <button id="memberConfirm" class="btn vm-glow-button mt-3 w-100 justify-content-center"><i class="bi bi-check-circle me-2"></i>確認會員</button>
                  <button id="guestModeBtn" class="btn btn-outline-light btn-soft mt-3 w-100"><i class="bi bi-incognito me-2"></i>改以訪客模式操作</button>
                </div>
                <div id="memStatus" class="glass-ring text-secondary mt-3">等待掃描會員卡...</div>
              </div>
            </div>
          </div>
        </section>
        <section class="checkout-step" data-step="code">
          <div class="glass-card recycle-card p-5">
            <div class="row g-4 align-items-center">
              <div class="col-lg-4 d-flex justify-content-center">
                <div class="recycle-hero-icon barcode">
                  <i class="bi bi-upc"></i>
                </div>
              </div>
              <div class="col-lg-8">
                <div class="scan-display recycle-scan">
                  <input id="codeInput" placeholder="請掃描 SKU 或收據碼" autocomplete="off">
                  <small>掃描實品條碼或輸入 <code>tx|sku|idx</code> 收據碼。訪客亦可直接輸入條碼試算可退押金。</small>
                  <button id="precheckBtn" class="btn btn-primary mt-3"><i class="bi bi-search me-2"></i>開始預檢</button>
                </div>
                <div id="precheckStatus" class="glass-ring text-secondary gap-2 mt-3 d-none">
                  <span class="spinner-border spinner-border-sm text-primary" role="status" aria-hidden="true"></span>
                  <span>預檢中...</span>
                </div>
                <div class="step-nav mt-4">
                  <button class="btn btn-outline-secondary" data-step-back><i class="bi bi-arrow-left-circle me-2"></i>返回會員</button>
                  <span></span>
                </div>
              </div>
            </div>
          </div>
        </section>

        <section class="checkout-step" data-step="result">
          <div class="glass-card p-4 d-none" id="resultWrapper">
            <div class="d-flex justify-content-between align-items-start flex-wrap gap-3 mb-3">
              <div>
                <div class="text-secondary small">預檢結果</div>
                <h2 id="resultSku" class="h4 fw-semibold mb-1"></h2>
                <div id="resultSource" class="badge rounded-pill text-bg-info"></div>
              </div>
              <div class="text-end">
                <div class="text-secondary small">可退押金</div>
                <div id="resultDeposit" class="fs-3 fw-bold text-primary">$0</div>
              </div>
            </div>
            <div class="row g-3">
              <div class="col-md-4">
                <div class="glass-card p-3">
                  <div class="text-secondary small">減碳加分</div>
                  <div id="resultCarbon" class="fw-semibold text-success">+0 kg</div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="glass-card p-3">
                  <div class="text-secondary small">節水加分</div>
                  <div id="resultWater" class="fw-semibold text-info">+0 L</div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="glass-card p-3">
                  <div class="text-secondary small">每日上限</div>
                  <div id="resultLimit" class="fw-semibold">安全</div>
                </div>
              </div>
            </div>
            <div id="resultWarning" class="alert alert-warning d-none mt-3"></div>
            <div class="d-flex flex-wrap gap-3 mt-4" id="decisionButtons">
              <button id="btnAccept" class="btn btn-soft"><i class="bi bi-check-circle me-2"></i>確認退押金</button>
              <button id="btnReject" class="btn btn-outline-secondary btn-soft"><i class="bi bi-x-circle me-2"></i>拒絕</button>
              <button id="clearBtn" class="btn btn-outline-light btn-soft"><i class="bi bi-arrow-repeat me-2"></i>下一筆</button>
            </div>
            <div id="finalMessage" class="mt-3 d-none"></div>
          </div>
        </section>
      </div>
    </div>
  </main>

  <footer class="py-4 text-white text-center bg-primary mt-auto">
    <small>© 2025 循環販賣機 Demo</small>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/assets/app.js"></script>
  <script>
    const memInput = document.getElementById('memInput');
    const codeInput = document.getElementById('codeInput');
    const precheckBtn = document.getElementById('precheckBtn');
    const clearBtn = document.getElementById('clearBtn');
    const statusRing = document.getElementById('precheckStatus');
    const resultWrapper = document.getElementById('resultWrapper');
    const resultSku = document.getElementById('resultSku');
    const resultSource = document.getElementById('resultSource');
    const resultDeposit = document.getElementById('resultDeposit');
    const resultCarbon = document.getElementById('resultCarbon');
    const resultWater = document.getElementById('resultWater');
    const resultLimit = document.getElementById('resultLimit');
    const resultWarning = document.getElementById('resultWarning');
    const btnAccept = document.getElementById('btnAccept');
    const btnReject = document.getElementById('btnReject');
    const decisionButtons = document.getElementById('decisionButtons');
    const finalMessage = document.getElementById('finalMessage');
    const memStatus = document.getElementById('memStatus');
    const memberConfirmBtn = document.getElementById('memberConfirm');
    const guestModeBtn = document.getElementById('guestModeBtn');
    const stepHint = document.getElementById('stepHint');

    const BADGE_MAP = { barcode:'條碼掃描', receipt:'收據碼' };

    let lastPrecheck = null;
    const stepOrder = ['member','code','result'];
    const stepBubbles = Array.from(document.querySelectorAll('.step-bubble'));
    let currentStepIndex = 0;

    const MEMBER_HINT = '請掃描會員卡後自動前往條碼掃描';
    const GUEST_HINT = '訪客模式：可直接掃描條碼試算可退押金';
    let guestMode = false;
    stepHint.textContent = MEMBER_HINT;

    function updateStepHint(step){
      if(guestMode && step !== 'member'){
        stepHint.textContent = GUEST_HINT;
        return;
      }
      const hints = {
        member: MEMBER_HINT,
        code: '掃描商品條碼或輸入收據碼預檢可退押金',
        result: '確認押金金額與 ESG 效益後，選擇退押或拒收'
      };
      stepHint.textContent = hints[step] || '';
    }

    function goToStep(step){
      const idx = stepOrder.indexOf(step);
      if(idx === -1) return;
      currentStepIndex = idx;
      document.querySelectorAll('.checkout-step').forEach(section=>{
        section.classList.toggle('active', section.dataset.step === step);
      });
      stepBubbles.forEach(bubble=>{
        const bubbleIdx = stepOrder.indexOf(bubble.dataset.step);
        bubble.classList.toggle('active', bubbleIdx === idx);
        bubble.classList.toggle('completed', bubbleIdx < idx);
      });
      updateStepHint(step);
      focusStepInput(step);
    }

    function focusStepInput(step){
      if(step === 'member'){
        setTimeout(()=>memInput.focus(), 180);
      } else if(step === 'code'){
        setTimeout(()=>codeInput.focus(), 180);
      }
    }

    function setLoading(flag){
      statusRing.classList.toggle('d-none', !flag);
      precheckBtn.disabled = flag;
    }

    function resetView(){
      resultWrapper.classList.add('d-none');
      resultWarning.classList.add('d-none');
      finalMessage.classList.add('d-none');
      decisionButtons.classList.remove('d-none');
      lastPrecheck = null;
    }

    async function resolveMember(code){
      const mem = code.trim();
      if(guestMode) disableGuestMode();
      if(!mem){
        App.bootstrapToast('請輸入或掃描會員卡號', 'warning');
        return;
      }
      resetView();
      memInput.value = mem;
      memStatus.innerHTML = `<div class="glass-ring text-secondary"><span class="spinner-border spinner-border-sm text-primary"></span> 驗證中...</div>`;
      try{
        const res = await fetch('/api/members/resolve',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ mem_no: mem })
        });
        const data = await res.json();
        if(!res.ok) throw new Error(data.error || '找不到會員');
        memStatus.innerHTML = `<div class="glass-ring text-success"><i class="bi bi-person-check me-2"></i>${data.name || '會員'} ｜ 押金 ${(data.deposit_balance_cents/100).toFixed(0)} 元</div>`;
        App.bootstrapToast('會員識別成功', 'success');
        goToStep('code');
      } catch(err){
        console.error(err);
        memStatus.innerHTML = `<div class="glass-ring text-danger"><i class="bi bi-exclamation-triangle me-2"></i>${err.message}</div>`;
        App.bootstrapToast(err.message, 'danger');
      }
    }

    function renderPrecheck(data){
      lastPrecheck = data;
      resultSku.textContent = data.sku_name;
      resultSource.textContent = BADGE_MAP[data.source] || data.source;
      resultDeposit.textContent = `$${(data.refundable_cents/100).toFixed(0)}`;
      resultCarbon.textContent = `+${data.carbon_credit} kg`;
      resultWater.textContent = `+${data.water_credit} L`;
      resultLimit.textContent = data.warn ? '接近上限' : '安全';
      if(data.warn){
        resultWarning.textContent = data.warn;
        resultWarning.classList.remove('d-none');
      } else {
        resultWarning.classList.add('d-none');
      }
      decisionButtons.classList.remove('d-none');
      finalMessage.classList.add('d-none');
      resultWrapper.classList.remove('d-none');
      goToStep('result');
    }

    async function doPrecheck(){
      const mem = memInput.value.trim();
      const code = codeInput.value.trim();
      if(!guestMode && !mem){
        App.bootstrapToast('請先完成會員掃描或啟用訪客模式', 'warning');
        goToStep('member');
        return;
      }
      if(!code){
        App.bootstrapToast('請輸入商品條碼或收據碼', 'warning');
        return;
      }
      resetView();
      setLoading(true);
      try{
        const res = await fetch('/api/recycle/precheck',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ mem_no: guestMode ? null : mem, code })
        });
        const data = await res.json();
        if(!res.ok) throw new Error(data.error || '預檢失敗');
        renderPrecheck(data);
        App.bootstrapToast('預檢完成，確認資訊後選擇退押或拒收', 'success');
      } catch(err){
        App.bootstrapToast(err.message, 'danger');
      } finally {
        setLoading(false);
      }
    }

    async function postDecision(decision){
      if(!lastPrecheck){
        App.bootstrapToast('請先完成預檢', 'warning');
        return;
      }
      const mem = memInput.value.trim();
      const code = codeInput.value.trim();
      decisionButtons.classList.add('d-none');
      finalMessage.classList.remove('d-none');
      finalMessage.innerHTML = `<div class="glass-ring text-secondary"><span class="spinner-border spinner-border-sm text-primary"></span> 處理中…</div>`;
      try{
        const res = await fetch('/api/recycle/confirm',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ mem_no: guestMode ? null : mem, code, decision })
        });
        const data = await res.json();
        if(!res.ok) throw new Error(data.error || '操作失敗');
        if(decision === 'accept'){
          const balanceText = (data.member_balance_cents != null)
            ? `會員押金餘額 $${(data.member_balance_cents/100).toFixed(0)}`
            : '訪客請於現場完成押金退還。';
          finalMessage.innerHTML = `
            <div class="d-flex flex-column gap-2">
              <div class="glass-ring text-success"><i class="bi bi-check-circle me-2"></i>已退押金 $${(data.refunded_cents/100).toFixed(0)}</div>
              <div class="text-secondary small">${balanceText}</div>
              <a class="btn btn-soft mt-2" href="/dashboard.html"><i class="bi bi-bar-chart-line me-2"></i>看 ESG 儀表板</a>
            </div>`;
        } else {
          finalMessage.innerHTML = `<div class="glass-ring text-secondary"><i class="bi bi-x-circle me-2"></i>已記錄拒收。</div>`;
        }
        App.bootstrapToast(decision === 'accept' ? '退押金完成！' : '已拒收本次回收', 'success');
        lastPrecheck = null;
      } catch(err){
        decisionButtons.classList.remove('d-none');
        finalMessage.classList.add('d-none');
        App.bootstrapToast(err.message, 'danger');
      }
    }

    precheckBtn.addEventListener('click', doPrecheck);
    btnAccept.addEventListener('click', ()=>postDecision('accept'));
    btnReject.addEventListener('click', ()=>postDecision('reject'));

    clearBtn.addEventListener('click', ()=>{
      codeInput.value = '';
      resetView();
      goToStep('code');
      focusStepInput('code');
    });

    memberConfirmBtn.addEventListener('click', ()=>resolveMember(memInput.value));
    codeInput.addEventListener('blur', ()=>{
      if(codeInput.dataset.skipBlurRun === '1'){
        codeInput.dataset.skipBlurRun = '';
        return;
      }
      const trimmed = (codeInput.value || '').trim();
      if(trimmed){
        doPrecheck();
      }
    });
    function enableGuestMode(){
      guestMode = true;
      memInput.value = '';
      memInput.disabled = true;
      memberConfirmBtn.disabled = true;
      memStatus.innerHTML = `<div class="glass-ring text-info"><i class="bi bi-incognito me-2"></i>訪客模式：僅示範退押金流程。</div>`;
      guestModeBtn.classList.add('active');
      guestModeBtn.innerHTML = '<i class="bi bi-person-badge me-2"></i>返回會員模式';
      stepHint.textContent = GUEST_HINT;
      goToStep('code');
      focusStepInput('code');
    }

    function disableGuestMode(){
      guestMode = false;
      memInput.disabled = false;
      memberConfirmBtn.disabled = false;
      memStatus.innerHTML = `<div class="glass-ring text-secondary">等待掃描會員卡...</div>`;
      guestModeBtn.classList.remove('active');
      guestModeBtn.innerHTML = '<i class="bi bi-incognito me-2"></i>改以訪客模式操作';
      stepHint.textContent = MEMBER_HINT;
    }

    guestModeBtn.addEventListener('click', ()=>{
      if(guestMode){
        disableGuestMode();
        goToStep('member');
        focusStepInput('member');
      } else {
        enableGuestMode();
      }
    });

    App.attachScanHandler('#memInput', resolveMember, { autoTrigger: true, skipEmpty: true });
    

    codeInput.addEventListener('keydown', e=>{
      if(e.key === 'Enter'){
        e.preventDefault();
        codeInput.dataset.skipBlurRun = '1';
        doPrecheck();
      }
    });

    document.querySelectorAll('[data-step-back]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const prevIdx = Math.max(0, currentStepIndex - 1);
        goToStep(stepOrder[prevIdx]);
      });
    });

    focusStepInput('member');
  </script>
</body>
</html>
