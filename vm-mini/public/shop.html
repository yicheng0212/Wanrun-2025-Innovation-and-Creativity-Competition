<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>商品選購｜循環販賣機</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link rel="stylesheet" href="/assets/styles.css">
</head>
<body class="min-vh-100 d-flex flex-column page-shop">
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
    <div class="container">
      <a class="navbar-brand fw-semibold" href="/index.html"><i class="bi bi-recycle me-2"></i>循環販賣機 DEMO</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav" aria-controls="mainNav" aria-expanded="false" aria-label="切換導覽">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="mainNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="/index.html">體驗入口</a></li>
          <li class="nav-item"><a class="nav-link" href="/scan.html">會員掃碼</a></li>
          <li class="nav-item"><a class="nav-link active" aria-current="page" href="/shop.html">訪客購物</a></li>
          <li class="nav-item"><a class="nav-link" href="/recycle.html">回收端</a></li>
          <li class="nav-item"><a class="nav-link" href="/dashboard.html">ESG 儀表板</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <main class="vm-stage">
    <div class="container">
      <div class="vm-shell">
        <div class="vm-top-bar">
          <div class="vm-logo"><i class="bi bi-box-seam"></i>VM-01X</div>
          <div class="d-flex align-items-center gap-3">
            <div class="vm-pill-display"><span class="vm-led-dot"></span><span id="vmStatusText">貨槽維持最佳狀態</span></div>
            <div class="vm-pill-display"><i class="bi bi-clock me-2"></i><span id="vmClock">--:--</span></div>
          </div>
        </div>
        <div class="vm-body">
          <section class="vm-screen">
            <div class="vm-screen-body">
              <div id="list" class="vm-shelf mb-4"></div>

              <div class="glass-card p-4 p-lg-5 mb-4 shop-controls">
                <div class="d-flex flex-column flex-xl-row justify-content-between gap-4 align-items-start">
                  <div>
                    <span class="badge bg-success-subtle text-success-emphasis mb-2">Step 2</span>
                    <h1 class="fw-bold text-white mb-2">挑選循環飲品，累積 ESG 成效</h1>
                    <p class="text-secondary mb-3">系統即時計算庫存與 ESG 指標，打造 Premium Vending Machine 般的沉浸體驗。</p>
                    <div id="memInfo"></div>
                  </div>
                  <div class="glass-card p-4 bg-opacity-50 bg-dark-subtle text-secondary shop-control-panel">
                    <div class="row g-3 align-items-end">
                      <div class="col-lg-6">
                        <label class="form-label text-secondary small mb-1" for="searchInput">搜尋商品 / 類別</label>
                        <div class="input-group input-group-lg">
                          <span class="input-group-text"><i class="bi bi-search"></i></span>
                          <input id="searchInput" class="form-control" placeholder="輸入商品名稱或關鍵字">
                        </div>
                      </div>
                      <div class="col-lg-6">
                        <label class="form-label text-secondary small mb-1">快速篩選</label>
                        <div class="d-flex flex-wrap gap-2 justify-content-lg-end" id="categoryFilters"></div>
                      </div>
                    </div>
                    <div class="text-secondary small mt-3 eco-highlight">減碳越多，回收回饋越高，最高可獲得 $15 的綠色回饋金。</div>
                  </div>
                </div>
              </div>
            </div>
          </section>
        </div>
      </div>
    </div>
  </main>

  <button id="checkoutBtn" class="btn btn-primary btn-lg floating-action" type="button" data-bs-toggle="offcanvas" data-bs-target="#cartOffcanvas">
    <i class="bi bi-bag-check me-2"></i>
    <span>購物車 (0)</span>
  </button>

  <div class="offcanvas offcanvas-end" tabindex="-1" id="cartOffcanvas">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title"><i class="bi bi-bag-heart me-2 text-primary"></i>購物車明細</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body d-flex flex-column gap-3">
      <div id="cartList" class="list-group list-group-flush list-group-animated flex-grow-1 overflow-auto"></div>
      <div id="cartSummary" class="glass-card p-4"></div>
      <div class="d-flex gap-3">
        <button id="clearCart" class="btn btn-outline-secondary flex-grow-1"><i class="bi bi-trash3 me-2"></i>清空購物車</button>
        <a id="toCheckout" class="btn btn-primary flex-grow-1"><i class="bi bi-arrow-right-circle me-2"></i>前往結帳</a>
      </div>
    </div>
  </div>

  <footer class="py-4 text-white text-center bg-primary mt-auto">
    <small>© 2025 循環販賣機 Demo</small>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/assets/app.js"></script>
  <script>
    const url = new URL(location.href);
    const mem = url.searchParams.get('mem') || '';
    const CART_KEY = 'cart:' + (mem || 'guest');
    let cart = JSON.parse(localStorage.getItem(CART_KEY) || '[]');
    let skuList = [];
    let skuMap = new Map();
    const state = { category: 'all', search: '' };

    const $list = document.getElementById('list');
    const $checkoutBtn = document.getElementById('checkoutBtn');
    const $checkoutBtnLabel = $checkoutBtn.querySelector('span');
    const $cartList = document.getElementById('cartList');
    const $cartSummary = document.getElementById('cartSummary');
    const cartOffcanvasEl = document.getElementById('cartOffcanvas');
    const $searchInput = document.getElementById('searchInput');
    const $categoryFilters = document.getElementById('categoryFilters');
    const $toCheckout = document.getElementById('toCheckout');
    const filterKeypad = document.getElementById('filterKeypad');
    const statEls = {
      balance: null,
      items: null,
      deposit: null,
      carbon: null,
      water: null
    };
    const rewardDisplayRange = { min: 5, max: 15 }; // 展示資訊用

    const iconMap = {
      '茶飲': 'bi-cup-hot',
      '咖啡': 'bi-cup-hot',
      '氣泡水': 'bi-cup-straw',
      '氣泡飲': 'bi-cup-straw',
      '特調': 'bi-cup-straw',
      '植物奶': 'bi-emoji-smile',
      '能量飲': 'bi-lightning',
      '功能飲': 'bi-droplet-half',
      '果汁': 'bi-cup-straw'
    };

    function rewardCentsFor(item){
      return Number(item?.reward_cents ?? item?.deposit_cents ?? 0);
    }

    function rewardLabel(cents){
      if(!Number.isFinite(cents)) return rewardDisplayRange.min;
      return Math.min(rewardDisplayRange.max, Math.max(rewardDisplayRange.min, Math.round(cents / 100)));
    }

    function getCarbonTier(carbonSaving){
      const value = Number(carbonSaving) || 0;
      if(value >= 0.10){
        return { label: '超高減碳', className: 'carbon-tier-high' };
      }
      if(value >= 0.07){
        return { label: '高減碳', className: 'carbon-tier-mid' };
      }
      return { label: '入門減碳', className: 'carbon-tier-base' };
    }

    let memberInfo = null;

    async function loadSkuList(){
      const res = await fetch('/api/sku');
      skuList = await res.json();
      skuList.sort((a,b)=>(Number(a.lane_no||0) - Number(b.lane_no||0)));
      skuMap = new Map(skuList.map(item => [item.id, item]));
      renderFilters();
      renderSkuList();
    }

    function persistCart(){
      localStorage.setItem(CART_KEY, JSON.stringify(cart));
    }

    function uniqueCategories(){
      const set = new Set();
      skuList.forEach(item=>{
        if(item.category) set.add(item.category);
      });
      return Array.from(set);
    }

    function filterItems(){
      const keyword = state.search.trim().toLowerCase();
      return skuList.filter(item=>{
        const matchCat = state.category === 'all' || item.category === state.category;
        const keywordMatch = !keyword || [item.name, item.category, item.id].some(v => (v || '').toLowerCase().includes(keyword));
        return matchCat && keywordMatch;
      });
    }

    function formatLane(no){
      const lane = Number(no);
      if(Number.isNaN(lane) || lane <= 0) return '--';
      const index = lane - 1;
      const row = Math.floor(index / 10);
      const col = index % 10;
      const letter = String.fromCharCode(65 + row);
      return `${letter}${String(col + 1).padStart(2, '0')}`;
    }
    // 產生玻璃質感的分類籤，支援即時切換
    function renderFilters(){
      const cats = uniqueCategories();
      const buttons = [
        `<button type="button" class="filter-chip ${state.category==='all'?'active':''}" data-category="all"><i class="bi bi-grid me-1"></i>全部品項</button>`,
        ...cats.map(cat=>`<button type="button" class="filter-chip ${state.category===cat?'active':''}" data-category="${cat}"><i class="bi bi-tag me-1"></i>${cat}</button>`)
      ];
      $categoryFilters.innerHTML = buttons.join('');
      $categoryFilters.querySelectorAll('button').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          state.category = btn.dataset.category;
          renderFilters();
          renderSkuList();
        });
      });
    }
    // 繪製商品卡片：套用漸層 Hero、ESG 指標與加入購物袋按鈕
    function renderSkuList(){
      const items = filterItems();

      if(items.length === 0){
        $list.innerHTML = `
          <div class="glass-card p-5 text-center text-secondary">
            <i class="bi bi-emoji-frown fs-1 d-block mb-3"></i>
            <p class="mb-0">找不到符合條件的商品，請調整搜尋或分類。</p>
          </div>`;
        return;
      }

      $list.innerHTML = items.map(item=>{
        const icon = iconMap[item.category] || 'bi-cup-straw';
        const laneLabel = formatLane(item.lane_no);
        const rewardCents = rewardCentsFor(item);
        const rewardValue = rewardLabel(rewardCents);
        const tier = getCarbonTier(item.carbon_saving);
        const carbonText = Number(item.carbon_saving || 0).toFixed(3);
        const waterText = Number(item.water_saving || 0).toFixed(1);
        const thumbContent = item.image_url
          ? `<img src="${item.image_url}" alt="${item.name} 包裝示意" class="vm-shelf-img" loading="lazy">`
          : `<div class="vm-thumb-fallback"><i class="bi ${icon}"></i></div>`;
        return `
          <article class="vm-shelf-item card-lift">
            <div class="vm-shelf-thumb">
              ${thumbContent}
              <div class="lane-chip">${laneLabel}</div>
              <div class="vm-scan-badge"><i class="bi bi-upc-scan me-1"></i>SCAN</div>
            </div>
            <div class="vm-shelf-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="badge vm-category-tag">${item.category || '循環飲品'}</span>
                <span class="badge carbon-tier ${tier.className}">${tier.label}</span>
              </div>
              <h3 class="mb-2">${item.name}</h3>
              <div class="vm-shelf-metrics small mb-3">
                <span><i class="bi bi-cloud-sun me-1"></i>減碳 ${carbonText} kg</span>
                <span><i class="bi bi-droplet me-1"></i>節水 ${waterText} L</span>
              </div>
              <div class="d-flex justify-content-between align-items-end">
                <div>
                  <div class="price-tag">$${(item.price_cents/100).toFixed(0)}</div>
                  <div class="reward-pill ${tier.className}">
                    <i class="bi bi-recycle me-1"></i>回收回饋 $${rewardValue}
                  </div>
                </div>
                <div class="text-secondary text-end small">
                  <div>庫存 ${item.stock}</div>
                  <div>掃碼加入購物袋</div>
                </div>
              </div>
            </div>
            <div class="vm-shelf-footer">
              <button class="btn btn-soft icon-only" data-action="add" data-sku="${item.id}" title="加入購物袋" aria-label="加入購物袋">
                <i class="bi bi-bag-plus-fill"></i>
              </button>
            </div>
          </article>
        `;
      }).join('');

      $list.querySelectorAll('[data-action="add"]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          addToCart(btn.dataset.sku);
        });
      });
    }

    function calculateCartMetrics(){
      let itemCount = 0;
      let totalCents = 0;
      let rewardCents = 0;
      let carbon = 0;
      let water = 0;

      cart.forEach(entry=>{
        const sku = skuMap.get(entry.sku_id);
        if(!sku) return;
        const qty = Number(entry.qty || 0);
        const incentive = rewardCentsFor(sku);
        itemCount += qty;
        totalCents += (sku.price_cents + incentive) * qty;
        rewardCents += incentive * qty;
        carbon += (sku.carbon_saving || 0) * qty;
        water += (sku.water_saving || 0) * qty;
      });

      return { itemCount, totalCents, rewardCents, carbon, water };
    }
    // 動態呈現購物車明細，並同步更新指標與按鈕狀態
    function renderCart(){
      const { itemCount, totalCents, rewardCents, carbon, water } = calculateCartMetrics();

      if(cart.length === 0){
        $cartList.innerHTML = `<div class="text-center text-secondary py-5"><i class="bi bi-bag-dash fs-1 d-block mb-3"></i>購物車是空的，挑幾款循環飲品試試吧！</div>`;
      } else {
        $cartList.innerHTML = cart.map(entry=>{
          const sku = skuMap.get(entry.sku_id);
          if(!sku) return '';
          const qty = Number(entry.qty || 0);
          const incentive = rewardLabel(rewardCentsFor(sku));
          return `
            <div class="list-group-item d-flex align-items-center justify-content-between">
              <div>
                <strong>${sku.name}</strong>
                <div class="text-secondary small">單價 $${(sku.price_cents/100).toFixed(0)} ｜ 回收回饋 $${incentive}</div>
              </div>
              <div class="d-flex align-items-center gap-2">
                <button class="btn btn-outline-secondary btn-sm" data-action="qty" data-id="${sku.id}" data-delta="-1"><i class="bi bi-dash"></i></button>
                <span class="fw-semibold">${qty}</span>
                <button class="btn btn-outline-secondary btn-sm" data-action="qty" data-id="${sku.id}" data-delta="1"><i class="bi bi-plus"></i></button>
              </div>
            </div>
          `;
        }).join('');

        $cartList.querySelectorAll('[data-action="qty"]').forEach(btn=>{
          btn.addEventListener('click', ()=>{
            changeQuantity(btn.dataset.id, Number(btn.dataset.delta));
          });
        });
      }

      $cartSummary.innerHTML = `
        <div class="d-flex justify-content-between mb-2">
          <span class="text-secondary">商品件數</span>
          <span class="fw-semibold">${itemCount}</span>
        </div>
        <div class="d-flex justify-content-between mb-2">
          <span class="text-secondary">回收回饋</span>
          <span class="fw-semibold">$${(rewardCents/100).toFixed(0)}</span>
        </div>
        <div class="d-flex justify-content-between mb-2">
          <span class="text-secondary">結帳金額 (含回饋預付)</span>
          <span class="fs-4 fw-bold text-primary">$${(totalCents/100).toFixed(0)}</span>
        </div>
        <div class="bg-success-subtle text-success-emphasis rounded-4 p-3">
          <div class="fw-semibold">本次 ESG 貢獻</div>
          <small>減碳 ${carbon.toFixed(3)} kg CO₂e ／ 節水 ${water.toFixed(1)} L</small>
        </div>
      `;

      const checkoutHref = mem ? `/checkout.html?mem=${encodeURIComponent(mem)}` : '/checkout.html';
      $toCheckout.href = checkoutHref;
      $toCheckout.classList.toggle('disabled', itemCount === 0);
      $checkoutBtnLabel.textContent = `購物車 (${itemCount})`;
      $checkoutBtn.disabled = itemCount === 0;

      if(statEls.items && statEls.deposit){
        if(window.App && App.animateCounter){
          App.animateCounter(statEls.items, itemCount);
          App.animateCounter(statEls.deposit, Math.round(rewardCents/100));
        } else {
          statEls.items.textContent = itemCount;
          statEls.deposit.textContent = (rewardCents/100).toFixed(0);
        }
      }
      if(statEls.carbon){
        statEls.carbon.textContent = carbon.toFixed(3);
      }
      if(statEls.water){
        statEls.water.textContent = water.toFixed(1);
      }
    }

    function addToCart(skuId){
      const existing = cart.find(item => item.sku_id === skuId);
      if(existing){
        existing.qty = Number(existing.qty || 0) + 1;
      } else {
        cart.push({ sku_id: skuId, qty: 1 });
      }
      persistCart();
      renderCart();
      const sku = skuMap.get(skuId);
      App.bootstrapToast(`${sku?.name || '商品'} 已加入購物車`, 'success');
    }

    function changeQuantity(skuId, delta){
      const entry = cart.find(item => item.sku_id === skuId);
      if(!entry) return;
      entry.qty = Number(entry.qty || 0) + delta;
      if(entry.qty <= 0){
        cart = cart.filter(item => item !== entry);
      }
      persistCart();
      renderCart();
    }

    document.getElementById('clearCart').addEventListener('click', ()=>{
      cart = [];
      persistCart();
      renderCart();
      App.bootstrapToast('購物車已清空', 'warning');
    });

    // 前往結帳時自動收起 offcanvas，避免遮擋畫面
    const toCheckoutBtn = document.getElementById('toCheckout');
    const offcanvasInstance = (window.bootstrap && cartOffcanvasEl)
      ? bootstrap.Offcanvas.getOrCreateInstance(cartOffcanvasEl)
      : null;

    toCheckoutBtn.addEventListener('click', ()=>{
      if(offcanvasInstance){
        offcanvasInstance.hide();
      }
    });

    if(offcanvasInstance){
      cartOffcanvasEl.addEventListener('show.bs.offcanvas', ()=>{
        $checkoutBtn.classList.add('d-none');
      });
      cartOffcanvasEl.addEventListener('hidden.bs.offcanvas', ()=>{
        $checkoutBtn.classList.remove('d-none');
      });
    }

    $searchInput.addEventListener('input', ()=>{
      state.search = $searchInput.value;
      renderSkuList();
    });

    (async()=>{
      if(mem){
        document.getElementById('memInfo').innerHTML = `
          <div class="glass-ring mem-summary">
            <i class="bi bi-person-badge-fill"></i>
            <span>會員卡 ${mem}</span>
          </div>`;
      } else {
        document.getElementById('memInfo').innerHTML = `
          <div class="glass-ring mem-summary muted">
            <i class="bi bi-incognito"></i>
            <span>訪客模式</span>
          </div>`;
      }

      await loadSkuList();
      renderCart();
    })();
    if(filterKeypad){
      filterKeypad.querySelectorAll('button[data-filter]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const key = btn.dataset.filter;
          if(key === 'clear'){
            $searchInput.value = '';
            state.category = 'all';
          } else if(key === 'all'){
            state.category = 'all';
          } else {
            state.category = key;
          }
          renderFilters();
          renderSkuList();
        });
      });
    }
  </script>
</body>
</html>
