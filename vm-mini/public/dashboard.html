<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ESG 儀表板｜循環販賣機</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link rel="stylesheet" href="/assets/styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="min-vh-100 d-flex flex-column bg-brand-dark text-white esg-dashboard">
  <nav class="navbar navbar-expand-lg navbar-dark bg-transparent py-4">
    <div class="container">
      <a class="navbar-brand fw-semibold text-info" href="/index.html"><i class="bi bi-recycle me-2"></i>循環販賣機 DEMO</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav" aria-controls="mainNav" aria-expanded="false" aria-label="切換導覽">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="mainNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link text-light" href="/scan.html">會員掃描</a></li>
          <li class="nav-item"><a class="nav-link text-light" href="/shop.html">訪客購物</a></li>
          <li class="nav-item"><a class="nav-link text-light" href="/checkout.html">三段式結帳</a></li>
          <li class="nav-item"><a class="nav-link text-info fw-semibold" aria-current="page" href="/dashboard.html">ESG 儀表板</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <main class="flex-grow-1">
    <div class="dashboard-hero">
      <div class="container">
        <div class="row g-4 align-items-center">
          <div class="col-lg-7">
            <div class="hero-inner">
              <span class="badge bg-info-subtle text-info-emphasis hero-badge mb-3">Live ESG Feed</span>
              <h1 class="display-4 fw-bold text-info mb-3">循環販賣機永續指揮中心</h1>
              <p class="text-secondary mb-4">今日每一筆成交、每一瓶回收即時反映在此儀表板，收入、押金與 ESG 數據同步亮相。</p>
              <div class="hero-stats">
                <div class="hero-stat-card">
                  <div class="label">今日營收</div>
                  <div id="revT" class="value">-</div>
                </div>
                <div class="hero-stat-card">
                  <div class="label">待退押金</div>
                  <div id="depT" class="value">-</div>
                </div>
                <div class="hero-stat-card">
                  <div class="label">減碳 (kg)</div>
                  <div id="carT" class="value">-</div>
                </div>
                <div class="hero-stat-card">
                  <div class="label">節水 (L)</div>
                  <div id="watT" class="value">-</div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-5">
            <div class="glass-card dark holo-card p-4 h-100">
              <h2 class="h5 text-info mb-3"><i class="bi bi-stars me-2"></i>今日亮點</h2>
              <ul id="highlightList" class="list-unstyled d-flex flex-column gap-3 mb-0"></ul>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container pb-5">
      <div class="row g-4 mt-1">
        <div class="col-xl-8">
          <div class="glass-card dark shadow-lg p-4 chart-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h2 class="h4 fw-semibold text-info mb-0"><i class="bi bi-graph-up-arrow me-2"></i>7 日營收 × 押金 × 減碳</h2>
              <span class="text-secondary small">資料自動滾動更新</span>
            </div>
            <div class="chart-wrapper">
              <canvas id="chart"></canvas>
            </div>
          </div>
        </div>
        <div class="col-xl-4">
          <div class="glass-card dark shadow-lg p-4 h-100">
            <h2 class="h5 text-info mb-3"><i class="bi bi-compass me-2"></i>永續動能羅盤</h2>
            <div class="gauge-wrapper mb-3">
              <canvas id="esgGauge" width="280" height="280"></canvas>
              <div class="gauge-center">
                <span class="label">ESG Index</span>
                <span id="esgIndex" class="value">0%</span>
              </div>
            </div>
            <ul class="list-unstyled d-flex flex-column gap-3 mb-0">
              <li class="glass-card dark-subtle p-3">
                <div class="text-secondary small">累積營收</div>
                <div id="revAll" class="fs-4 fw-semibold">-</div>
              </li>
              <li class="glass-card dark-subtle p-3">
                <div class="text-secondary small">累積押金</div>
                <div id="depAll" class="fs-4 fw-semibold">-</div>
              </li>
              <li class="glass-card dark-subtle p-3">
                <div class="text-secondary small">累積減碳</div>
                <div id="carAll" class="fs-5 fw-semibold">-</div>
              </li>
              <li class="glass-card dark-subtle p-3">
                <div class="text-secondary small">累積節水</div>
                <div id="watAll" class="fs-5 fw-semibold">-</div>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer class="py-4 mt-auto text-center text-light">
    <small>© 2025 循環販賣機 Demo｜ESG 資料即時呈現</small>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/assets/app.js"></script>
  <script>
    const fmtMoney = cents => (window.App && App.formatMoney) ? App.formatMoney(cents) : ('$' + (Number(cents || 0)/100).toFixed(0));
    const $ = id => document.getElementById(id);

    (async()=>{
      const res = await fetch('/api/metrics/summary');
      const data = await res.json();

      $('revT').textContent = fmtMoney(data.today.revenue_today);
      $('depT').textContent = fmtMoney(data.today.deposit_today);
      $('carT').textContent = (data.today.carbon_today||0).toFixed(3)+' kg';
      $('watT').textContent = (data.today.water_today||0).toFixed(1)+' L';

      $('revAll').textContent = fmtMoney(data.total.revenue_all);
      $('depAll').textContent = fmtMoney(data.total.deposit_all);
      $('carAll').textContent = (data.total.carbon_all||0).toFixed(3)+' kg';
      $('watAll').textContent = (data.total.water_all||0).toFixed(1)+' L';

      const highlightList = $('highlightList');
      const todayRevenue = data.today.revenue_today/100;
      const depositPool = data.today.deposit_today/100;
      const carbon = data.today.carbon_today || 0;
      const water = data.today.water_today || 0;
      highlightList.innerHTML = `
        <li><i class="bi bi-cash-coin me-2 text-info"></i>今日營收 <strong>$${todayRevenue.toFixed(0)}</strong>，押金池待退 <strong>$${depositPool.toFixed(0)}</strong></li>
        <li><i class="bi bi-leaf me-2 text-success"></i>減碳 <strong>${carbon.toFixed(3)} kg</strong>，等同植樹 ${(carbon/0.009).toFixed(1)} 棵</li>
        <li><i class="bi bi-droplet-half me-2 text-primary"></i>節水 <strong>${water.toFixed(1)} L</strong>，等於 ${ (water/2).toFixed(1) } 杯咖啡水量</li>
      `;

      const labels = data.daily.map(d=>d.d);
      const revenue = data.daily.map(d=>(d.revenue_cents||0)/100);
      const carbonDaily = data.daily.map(d=>(d.carbon||0));
      const deposit = data.daily.map(d=>(d.deposit_cents||0)/100);

      const chartCtx = document.getElementById('chart').getContext('2d');
      const gradientRevenue = chartCtx.createLinearGradient(0,0,0,320);
      gradientRevenue.addColorStop(0,'rgba(56,189,248,0.55)');
      gradientRevenue.addColorStop(1,'rgba(56,189,248,0.05)');
      const gradientCarbon = chartCtx.createLinearGradient(0,0,0,320);
      gradientCarbon.addColorStop(0,'rgba(52,211,153,0.55)');
      gradientCarbon.addColorStop(1,'rgba(52,211,153,0.05)');

      new Chart(chartCtx, {
        type:'bar',
        data:{
          labels,
          datasets:[
            {
              type:'line',
              label:'每日營收',
              data: revenue,
              borderColor:'#38bdf8',
              backgroundColor: gradientRevenue,
              tension:0.35,
              fill:true,
              borderWidth:3,
              pointRadius:4,
              pointBackgroundColor:'#38bdf8'
            },
            {
              type:'bar',
              label:'每日押金池',
              data: deposit,
              backgroundColor:'rgba(129,140,248,0.4)',
              borderRadius:10,
              maxBarThickness:38,
              yAxisID:'y2'
            },
            {
              type:'line',
              label:'每日減碳 (kg)',
              data: carbonDaily,
              borderColor:'#34d399',
              backgroundColor: gradientCarbon,
              yAxisID:'y1',
              tension:0.35,
              borderWidth:3,
              pointRadius:4,
              pointBackgroundColor:'#34d399'
            }
          ]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          scales:{
            y:{
              grid:{color:'rgba(148,163,184,0.15)'},
              ticks:{color:'#cbd5f5'}
            },
            y1:{
              position:'right',
              grid:{display:false},
              ticks:{color:'#bbf7d0'}
            },
            y2:{
              position:'right',
              grid:{display:false},
              ticks:{color:'#c7d2fe'},
              offset:true
            },
            x:{
              ticks:{color:'#cbd5f5'},
              grid:{color:'rgba(148,163,184,0.08)'}
            }
          },
          plugins:{
            legend:{ labels:{ color:'#e2e8f0' } },
            tooltip:{
              backgroundColor:'rgba(15,23,42,0.9)',
              borderColor:'rgba(59,130,246,0.4)',
              borderWidth:1
            }
          }
        }
      });

      const gaugeCtx = document.getElementById('esgGauge').getContext('2d');
      const carbonTotal = data.total.carbon_all || 0;
      const waterTotal = data.total.water_all || 0;
      const esgIndex = carbonTotal + waterTotal === 0 ? 0 : Math.min(100, ((carbon + water) / (carbonTotal + waterTotal)) * 100);
      $('esgIndex').textContent = esgIndex.toFixed(1) + '%';

      new Chart(gaugeCtx, {
        type:'doughnut',
        data:{
          labels:['減碳','節水'],
          datasets:[{
            data:[carbonTotal, waterTotal],
            backgroundColor:['rgba(52,211,153,0.85)','rgba(59,130,246,0.85)'],
            borderWidth:0,
            hoverOffset:6
          }]
        },
        options:{
          cutout:'68%',
          plugins:{ legend:{ display:false } },
          rotation:-90,
          circumference:180
        }
      });
    })();
  </script>
</body>
</html>
