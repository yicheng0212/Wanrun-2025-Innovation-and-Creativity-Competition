<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ESG 儀表板｜循環販賣機</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link rel="stylesheet" href="/assets/styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="min-vh-100 d-flex flex-column bg-brand-dark text-white esg-dashboard">
  <nav class="navbar navbar-expand-lg navbar-dark bg-transparent py-4">
    <div class="container">
      <a class="navbar-brand fw-semibold text-info" href="/index.html"><i class="bi bi-recycle me-2"></i>循環販賣機 DEMO</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav" aria-controls="mainNav" aria-expanded="false" aria-label="切換導覽">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="mainNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link text-light" href="/scan.html">會員掃描</a></li>
          <li class="nav-item"><a class="nav-link text-light" href="/shop.html">訪客購物</a></li>
          <li class="nav-item"><a class="nav-link text-light" href="/checkout.html">三段式結帳</a></li>
          <li class="nav-item"><a class="nav-link text-info fw-semibold" aria-current="page" href="/dashboard.html">ESG 儀表板</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <main class="flex-grow-1">
    <div class="dashboard-hero">
      <div class="container">
        <div class="row g-4 align-items-center">
          <div class="col-lg-7">
            <div class="hero-inner">
              <span class="badge bg-info-subtle text-info-emphasis hero-badge mb-3">Live ESG Feed</span>
              <h1 class="display-4 fw-bold text-info mb-3">循環販賣機永續指揮中心</h1>
              <p class="text-secondary mb-4">今日每一筆成交、每一瓶回收即時反映在此儀表板，收入、押金與 ESG 數據同步亮相。</p>
              <div class="hero-stats">
                <div class="hero-stat-card">
                  <div class="label">今日營收</div>
                  <div id="revT" class="value">-</div>
                </div>
                <div class="hero-stat-card">
                  <div class="label">待退押金</div>
                  <div id="depT" class="value">-</div>
                </div>
                <div class="hero-stat-card">
                  <div class="label">減碳 (kg)</div>
                  <div id="carT" class="value">-</div>
                </div>
                <div class="hero-stat-card">
                  <div class="label">節水 (L)</div>
                  <div id="watT" class="value">-</div>
                </div>
                <div class="hero-stat-card">
                  <div class="label">今日退押率</div>
                  <div id="refundRateT" class="value">-</div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-5">
            <div class="glass-card dark holo-card p-4 h-100">
              <h2 class="h5 text-info mb-3"><i class="bi bi-stars me-2"></i>今日亮點</h2>
              <ul id="highlightList" class="list-unstyled d-flex flex-column gap-3 mb-0"></ul>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container pb-5">
      <div class="row g-4 mt-1">
        <div class="col-xl-8">
          <div class="glass-card dark shadow-lg p-4 chart-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h2 class="h4 fw-semibold text-info mb-0"><i class="bi bi-graph-up-arrow me-2"></i>7 日營收 × 押金 × 減碳</h2>
              <span class="text-secondary small">資料自動滾動更新</span>
            </div>
            <div class="chart-wrapper">
              <canvas id="chart"></canvas>
            </div>
          </div>
          <div class="glass-card dark shadow-lg p-4 mt-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h2 class="h5 fw-semibold text-info mb-0"><i class="bi bi-piggy-bank me-2"></i>押金回收雷達</h2>
              <span class="text-secondary small">收押金、退押金透明化</span>
            </div>
            <div class="row g-4">
              <div class="col-md-6">
                <div class="text-secondary text-uppercase small fw-semibold mb-2">今日節奏</div>
                <div class="mb-2">
                  <div class="d-flex justify-content-between small mb-1">
                    <span class="text-secondary">應退</span>
                    <span id="depositDueToday" class="fw-semibold">-</span>
                  </div>
                  <div class="d-flex justify-content-between small">
                    <span class="text-secondary">已退</span>
                    <span id="depositRefundToday" class="fw-semibold text-success">-</span>
                  </div>
                </div>
                <div class="progress bg-dark-subtle" style="height:8px;">
                  <div id="progressRefundToday" class="progress-bar bg-info" role="progressbar" style="width:0%" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <div class="text-secondary small mt-2">
                  退押率 <span id="depositRateToday">-</span> ・ 待退 <span id="depositPendingToday">-</span>
                </div>
              </div>
              <div class="col-md-6">
                <div class="text-secondary text-uppercase small fw-semibold mb-2">累積成效</div>
                <div class="mb-2">
                  <div class="d-flex justify-content-between small mb-1">
                    <span class="text-secondary">應退</span>
                    <span id="depositDueAll" class="fw-semibold">-</span>
                  </div>
                  <div class="d-flex justify-content-between small">
                    <span class="text-secondary">已退</span>
                    <span id="depositRefundAll" class="fw-semibold text-success">-</span>
                  </div>
                </div>
                <div class="progress bg-dark-subtle" style="height:8px;">
                  <div id="progressRefundAll" class="progress-bar bg-success" role="progressbar" style="width:0%" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <div class="text-secondary small mt-2">
                  退押率 <span id="depositRateAll">-</span> ・ 待退 <span id="depositPendingAll">-</span>
                </div>
                <div class="text-secondary small mt-3 d-flex align-items-center gap-2">
                  <i class="bi bi-recycle text-success"></i>
                  <span>累積回收 <span id="recycleAcceptedAllChip" class="text-success fw-semibold">-</span> 件 ・ 拒收 <span id="recycleRejectedAllChip" class="text-warning fw-semibold">-</span> 件</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-xl-4 d-flex flex-column gap-4">
          <div class="glass-card dark shadow-lg p-4 flex-grow-1">
            <h2 class="h5 text-info mb-3"><i class="bi bi-compass me-2"></i>永續動能羅盤</h2>
            <div class="gauge-wrapper mb-3">
              <canvas id="esgGauge" width="280" height="280"></canvas>
              <div class="gauge-center">
                <span class="label">ESG Index</span>
                <span id="esgIndex" class="value">0%</span>
              </div>
            </div>
            <ul class="list-unstyled d-flex flex-column gap-3 mb-0">
              <li class="glass-card dark-subtle p-3">
                <div class="text-secondary small">累積營收</div>
                <div id="revAll" class="fs-4 fw-semibold">-</div>
              </li>
              <li class="glass-card dark-subtle p-3">
                <div class="text-secondary small">累積押金</div>
                <div id="depAll" class="fs-4 fw-semibold">-</div>
                <div class="text-secondary small mt-2">已退 <span id="depAllRefunded" class="text-success fw-semibold">-</span> ・ 待退 <span id="depAllPending" class="fw-semibold">-</span></div>
                <div class="text-secondary small">退押率 <span id="depAllRate" class="text-info fw-semibold">-</span></div>
              </li>
              <li class="glass-card dark-subtle p-3">
                <div class="text-secondary small">累積減碳</div>
                <div id="carAll" class="fs-5 fw-semibold">-</div>
              </li>
              <li class="glass-card dark-subtle p-3">
                <div class="text-secondary small">累積節水</div>
                <div id="watAll" class="fs-5 fw-semibold">-</div>
              </li>
            </ul>
          </div>
          <div class="glass-card dark shadow-lg p-4">
            <h2 class="h5 text-info mb-3"><i class="bi bi-activity me-2"></i>回收動態追蹤</h2>
            <div class="recycle-summary d-flex flex-column flex-sm-row justify-content-between align-items-sm-end gap-4 mb-3">
              <div class="metric-block">
                <div class="text-secondary small text-uppercase">今日回收件數</div>
                <div id="recycleAcceptedToday" class="metric-value text-success">-</div>
              </div>
              <div class="metric-block text-sm-end">
                <div class="text-secondary small text-uppercase">今日拒收</div>
                <div id="recycleRejectedToday" class="metric-value text-warning">-</div>
              </div>
            </div>
            <div class="border-top border-secondary-subtle pt-3">
              <div class="text-secondary small mb-2">最近三日退押進度</div>
              <ul id="refundTrendList" class="list-unstyled d-flex flex-column gap-2 mb-3"></ul>
              <div class="d-flex justify-content-between align-items-center">
                <div class="text-secondary small">累積退押件數</div>
                <div class="text-end">
                  <div class="fw-semibold text-success" id="recycleAcceptedAll">-</div>
                  <div class="text-secondary small">拒收 <span id="recycleRejectedAll">-</span></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer class="py-4 mt-auto text-center text-light">
    <small>© 2025 循環販賣機 Demo｜ESG 資料即時呈現</small>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/assets/app.js"></script>
  <script>
    const fmtMoney = cents => (window.App && App.formatMoney) ? App.formatMoney(cents) : ('$' + (Number(cents || 0)/100).toFixed(0));
    const $ = id => document.getElementById(id);
    const formatPercent = (value, digits=1)=>{
      const rate = Math.max(0, Math.min(1, Number(value) || 0));
      return (rate * 100).toFixed(digits) + '%';
    };
    const formatCount = value => Number(value || 0).toLocaleString('zh-TW');
    const setProgress = (el, rate)=>{
      if(!el) return;
      const normalized = Math.max(0, Math.min(1, Number(rate) || 0));
      const width = (normalized * 100).toFixed(1);
      el.style.width = width + '%';
      el.setAttribute('aria-valuenow', width);
    };

    (async()=>{
      const res = await fetch('/api/metrics/summary');
      const data = await res.json();
      const { today, total, daily } = data;

      $('revT').textContent = fmtMoney(today.revenue_today);
      $('depT').textContent = fmtMoney(today.deposit_today);
      $('carT').textContent = (today.carbon_today||0).toFixed(3)+' kg';
      $('watT').textContent = (today.water_today||0).toFixed(1)+' L';
      $('refundRateT').textContent = formatPercent(today.deposit_refund_rate || 0);

      $('revAll').textContent = fmtMoney(total.revenue_all);
      $('depAll').textContent = fmtMoney(total.deposit_all);
      $('carAll').textContent = (total.carbon_all||0).toFixed(3)+' kg';
      $('watAll').textContent = (total.water_all||0).toFixed(1)+' L';
      $('depAllRefunded').textContent = fmtMoney(total.deposit_refunded);
      $('depAllPending').textContent = fmtMoney(total.deposit_pending);
      $('depAllRate').textContent = formatPercent(total.deposit_refund_rate || 0);

      $('depositDueToday').textContent = fmtMoney(today.deposit_today);
      $('depositRefundToday').textContent = fmtMoney(today.deposit_refunded);
      $('depositPendingToday').textContent = fmtMoney(today.deposit_pending);
      $('depositRateToday').textContent = formatPercent(today.deposit_refund_rate || 0);
      setProgress($('progressRefundToday'), today.deposit_refund_rate);

      $('depositDueAll').textContent = fmtMoney(total.deposit_all);
      $('depositRefundAll').textContent = fmtMoney(total.deposit_refunded);
      $('depositPendingAll').textContent = fmtMoney(total.deposit_pending);
      $('depositRateAll').textContent = formatPercent(total.deposit_refund_rate || 0);
      setProgress($('progressRefundAll'), total.deposit_refund_rate);

      $('recycleAcceptedAllChip').textContent = formatCount(total.recycle_accepted);
      $('recycleRejectedAllChip').textContent = formatCount(total.recycle_rejected);
      $('recycleAcceptedToday').textContent = formatCount(today.recycle_accepted);
      $('recycleRejectedToday').textContent = formatCount(today.recycle_rejected);
      $('recycleAcceptedAll').textContent = formatCount(total.recycle_accepted);
      $('recycleRejectedAll').textContent = formatCount(total.recycle_rejected);

      const highlightList = $('highlightList');
      if(highlightList){
        const revenueTodayFmt = fmtMoney(today.revenue_today);
        const depositTodayFmt = fmtMoney(today.deposit_today);
        const refundTodayFmt = fmtMoney(today.deposit_refunded);
        const pendingTodayFmt = fmtMoney(today.deposit_pending);
        const refundRateTodayFmt = formatPercent(today.deposit_refund_rate || 0);
        const carbonToday = today.carbon_today || 0;
        const waterToday = today.water_today || 0;
        const recycleAccepted = formatCount(today.recycle_accepted);
        const recycleRejected = formatCount(today.recycle_rejected);
        highlightList.innerHTML = `
          <li><i class="bi bi-cash-coin me-2 text-info"></i>今日營收 <strong>${revenueTodayFmt}</strong>，押金池待退 <strong>${depositTodayFmt}</strong></li>
          <li><i class="bi bi-piggy-bank me-2 text-warning"></i>已退押金 <strong>${refundTodayFmt}</strong>（${refundRateTodayFmt}），尚有 <strong>${pendingTodayFmt}</strong> 待退</li>
          <li><i class="bi bi-leaf me-2 text-success"></i>減碳 <strong>${carbonToday.toFixed(3)} kg</strong>，等同植樹 ${(carbonToday/0.009).toFixed(1)} 棵</li>
          <li><i class="bi bi-droplet-half me-2 text-primary"></i>節水 <strong>${waterToday.toFixed(1)} L</strong>，等於 ${(waterToday/2).toFixed(1)} 杯咖啡水量</li>
          <li><i class="bi bi-recycle me-2 text-info"></i>今日回收 <strong>${recycleAccepted}</strong> 件，拒收 <strong>${recycleRejected}</strong> 件</li>
        `;
      }

      const labels = daily.map(d=>d.d);
      const revenueSeries = daily.map(d=>(d.revenue_cents||0)/100);
      const carbonSeries = daily.map(d=>(d.carbon||0));
      const depositSeries = daily.map(d=>(d.deposit_cents||0)/100);
      const refundSeries = daily.map(d=>(d.refunded_cents||0)/100);

      const chartCtx = document.getElementById('chart').getContext('2d');
      const gradientRevenue = chartCtx.createLinearGradient(0,0,0,320);
      gradientRevenue.addColorStop(0,'rgba(56,189,248,0.55)');
      gradientRevenue.addColorStop(1,'rgba(56,189,248,0.05)');
      const gradientCarbon = chartCtx.createLinearGradient(0,0,0,320);
      gradientCarbon.addColorStop(0,'rgba(52,211,153,0.55)');
      gradientCarbon.addColorStop(1,'rgba(52,211,153,0.05)');
      const gradientDeposit = chartCtx.createLinearGradient(0,0,0,320);
      gradientDeposit.addColorStop(0,'rgba(129,140,248,0.45)');
      gradientDeposit.addColorStop(1,'rgba(129,140,248,0.08)');

      new Chart(chartCtx, {
        type:'bar',
        data:{
          labels,
          datasets:[
            {
              type:'bar',
              label:'每日押金池',
              data: depositSeries,
              backgroundColor: gradientDeposit,
              borderRadius:12,
              maxBarThickness:42,
              yAxisID:'y2',
              order:0
            },
            {
              type:'bar',
              label:'每日退押金',
              data: refundSeries,
              backgroundColor:'rgba(16,185,129,0.65)',
              borderRadius:10,
              maxBarThickness:26,
              yAxisID:'y2',
              order:1
            },
            {
              type:'line',
              label:'每日營收',
              data: revenueSeries,
              borderColor:'#38bdf8',
              backgroundColor: gradientRevenue,
              tension:0.35,
              fill:true,
              borderWidth:3,
              pointRadius:4,
              pointBackgroundColor:'#38bdf8',
              order:2
            },
            {
              type:'line',
              label:'每日減碳 (kg)',
              data: carbonSeries,
              borderColor:'#34d399',
              backgroundColor: gradientCarbon,
              yAxisID:'y1',
              tension:0.35,
              borderWidth:3,
              pointRadius:4,
              pointBackgroundColor:'#34d399',
              order:3
            }
          ]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          scales:{
            y:{
              grid:{color:'rgba(148,163,184,0.15)'},
              ticks:{color:'#cbd5f5'}
            },
            y1:{
              position:'right',
              grid:{display:false},
              ticks:{color:'#bbf7d0'},
              title:{display:true, text:'減碳 (kg)', color:'#bbf7d0', font:{size:12}}
            },
            y2:{
              position:'right',
              grid:{display:false},
              ticks:{color:'#c7d2fe'},
              offset:true,
              title:{display:true, text:'押金 / 退押 (NT$)', color:'#c7d2fe', font:{size:12}}
            },
            x:{
              ticks:{color:'#cbd5f5'},
              grid:{color:'rgba(148,163,184,0.08)'}
            }
          },
          plugins:{
            legend:{ labels:{ color:'#e2e8f0' } },
            tooltip:{
              backgroundColor:'rgba(15,23,42,0.9)',
              borderColor:'rgba(59,130,246,0.4)',
              borderWidth:1,
              callbacks:{
                label(context){
                  const label = context.dataset.label || '';
                  const value = context.parsed.y;
                  if(label.includes('減碳')){
                    return `${label}: ${value.toFixed(3)} kg`;
                  }
                  if(label.includes('押金') || label.includes('營收')){
                    return `${label}: ${fmtMoney(Math.round(value * 100))}`;
                  }
                  return `${label}: ${value}`;
                }
              }
            }
          }
        }
      });

      const gaugeCtx = document.getElementById('esgGauge').getContext('2d');
      const carbonTotal = total.carbon_all || 0;
      const waterTotal = total.water_all || 0;
      const carbonToday = today.carbon_today || 0;
      const waterToday = today.water_today || 0;
      const esgIndex = (carbonTotal + waterTotal) === 0
        ? 0
        : Math.min(100, ((carbonToday + waterToday) / (carbonTotal + waterTotal)) * 100);
      $('esgIndex').textContent = esgIndex.toFixed(1) + '%';

      new Chart(gaugeCtx, {
        type:'doughnut',
        data:{
          labels:['減碳','節水'],
          datasets:[{
            data:[carbonTotal, waterTotal],
            backgroundColor:['rgba(52,211,153,0.85)','rgba(59,130,246,0.85)'],
            borderWidth:0,
            hoverOffset:6
          }]
        },
        options:{
          cutout:'68%',
          plugins:{ legend:{ display:false } },
          rotation:-90,
          circumference:180
        }
      });

      const trendList = $('refundTrendList');
      if(trendList){
        const recent = daily.slice(-3).reverse();
        if(recent.length === 0){
          trendList.innerHTML = '<li class="text-secondary small">尚無退押紀錄</li>';
        } else {
          trendList.innerHTML = recent.map(row=>{
            const dateLabel = (row.d || '').slice(5) || row.d;
            const refundText = fmtMoney(row.refunded_cents || 0);
            const rateText = formatPercent(row.refund_rate || 0, 0);
            const acceptedCount = formatCount(row.accepted_count);
            const rejectedCount = formatCount(row.rejected_count);
            const suffix = rejectedCount && rejectedCount !== '0'
              ? `，${rejectedCount} 拒收`
              : '';
            return `
              <li class="d-flex justify-content-between align-items-center">
                <span class="text-secondary">${dateLabel}</span>
                <span class="text-light small">${refundText} / ${rateText} ・ ${acceptedCount} 接收${suffix}</span>
              </li>
            `;
          }).join('');
        }
      }
    })();
  </script>
</body>
</html>
